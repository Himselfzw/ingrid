<!DOCTYPE html>
<html lang="en">
<%- include('./components/head', { title: 'Admin Dashboard - Ingrid Chemicals' }) %>
<body class="admin-dashboard">
  <style>
    :root {
      --primary-color: hsl(220, 60%, 12%);
      --accent-color: hsl(45, 93%, 58%);
      --destructive-color: hsl(0, 84.2%, 60.2%);
      --bg-color: hsl(0, 0%, 100%);
      --fg-color: hsl(220, 60%, 12%);
      --muted-color: hsl(220, 20%, 95%);
      --border-color: hsl(220, 20%, 90%);
      --gradient-hero: linear-gradient(135deg, hsl(220, 60%, 12%), hsl(220, 60%, 20%));
      --gradient-accent: linear-gradient(135deg, hsl(45, 93%, 58%), hsl(45, 93%, 65%));
      --shadow-elegant: 0 4px 20px rgba(220, 60, 12, 0.15);
      --shadow-glow: 0 0 20px rgba(45, 93%, 58, 0.3);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: hsl(220, 60%, 8%);
        --fg-color: hsl(0, 0%, 100%);
        --muted-color: hsl(220, 60%, 15%);
        --border-color: hsl(220, 60%, 20%);
        --gradient-hero: linear-gradient(135deg, hsl(220, 60%, 8%), hsl(220, 60%, 15%));
        --shadow-elegant: 0 4px 20px rgba(0, 0, 0, 0.3);
        --shadow-glow: 0 0 20px rgba(45, 93%, 58, 0.5);
      }
    }

    .dashboard-card {
      border: none;
      border-radius: 8px;
      box-shadow: var(--shadow-elegant);
      transition: transform 0.2s;
      background-color: var(--bg-color);
      color: var(--fg-color);
    }

    .dashboard-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-glow);
    }

    .stats-card {
      text-align: center;
      padding: 20px;
    }

    .stats-number {
      font-size: 2rem;
      font-weight: bold;
      color: var(--accent-color);
      margin-bottom: 5px;
    }

    .stats-label {
      font-size: 0.9rem;
      color: var(--muted-color);
    }

    .form-section {
      background: var(--muted-color);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      color: var(--fg-color);
    }

    .action-btn {
      margin: 2px;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--muted-color);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .navbar {
      background: var(--gradient-hero) !important;
      box-shadow: var(--shadow-elegant);
    }

    .sidebar {
      background-color: var(--primary-color);
      color: white;
    }

    .sidebar .nav-link:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: white !important;
    }

    .sidebar .nav-link.active {
      background-color: var(--accent-color);
      color: var(--primary-color) !important;
    }

    .main-content {
      background-color: var(--bg-color);
      color: var(--fg-color);
    }

    .table {
      color: var(--fg-color);
    }

    .table thead th {
      background-color: var(--muted-color);
      border-color: var(--border-color);
      color: var(--fg-color);
    }

    .table tbody tr {
      background-color: var(--bg-color);
      border-color: var(--border-color);
    }

    .table tbody tr:hover {
      background-color: var(--muted-color);
    }

    .form-control {
      background-color: var(--bg-color);
      border-color: var(--border-color);
      color: var(--fg-color);
    }

    .form-control:focus {
      background-color: var(--bg-color);
      border-color: var(--accent-color);
      color: var(--fg-color);
    }

    .form-label {
      color: var(--fg-color);
    }

    .btn-outline-primary {
      color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-outline-primary:hover {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-outline-danger {
      color: var(--destructive-color);
      border-color: var(--destructive-color);
    }

    .btn-outline-danger:hover {
      background-color: var(--destructive-color);
      color: white;
    }

    .text-dark {
      color: var(--fg-color) !important;
    }

    .text-muted {
      color: var(--muted-color) !important;
    }

    .border-bottom {
      border-color: var(--border-color) !important;
    }

    .list-group-item {
      background-color: var(--bg-color);
      border-color: var(--border-color);
      color: var(--fg-color);
    }

    .list-group-item:hover {
      background-color: var(--muted-color);
    }

    .empty-state {
      color: var(--muted-color);
    }

    .empty-state i {
      color: var(--accent-color);
    }

    .modal-content {
      background-color: var(--bg-color);
      color: var(--fg-color);
    }

    .modal-header {
      border-bottom-color: var(--border-color);
    }

    .modal-footer {
      border-top-color: var(--border-color);
    }

    .alert-success {
      background-color: rgba(76, 175, 80, 0.1);
      border-color: #4caf50;
      color: #2e7d32;
    }

    .alert-danger {
      background-color: rgba(244, 67, 54, 0.1);
      border-color: #f44336;
      color: #c62828;
    }
  </style>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">
        <i class="bi bi-speedometer2"></i> Ingrid Chemicals Admin
      </a>
      <button class="btn btn-outline-light me-2 d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar">
        <i class="bi bi-list"></i>
      </button>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="/" target="_blank">
              <i class="bi bi-eye"></i> View Site
            </a>
          </li>
          <% if (user.role === 'superadmin') { %>
            <li class="nav-item">
              <a class="nav-link" href="/admin/super">
                <i class="bi bi-shield-lock"></i> Super Admin
              </a>
            </li>
          <% } %>
          <li class="nav-item">
            <button type="button" class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#logoutModal">
              <i class="bi bi-box-arrow-right"></i> Logout
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- CSRF token holder for client scripts -->
  <div id="csrf-holder" data-csrf="<%= csrfToken %>" style="display:none"></div>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 col-lg-2">
        <div class="collapse d-md-block sidebar" id="sidebar">
          <div class="position-sticky pt-3">
            <ul class="nav flex-column">
              <li class="nav-item">
                <a class="nav-link active" href="#dashboard" data-bs-toggle="tab">
                  <i class="bi bi-speedometer2"></i> Dashboard
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#products" data-bs-toggle="tab">
                  <i class="bi bi-box-seam"></i> Products
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#posts" data-bs-toggle="tab">
                  <i class="bi bi-file-text"></i> Posts
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#categories" data-bs-toggle="tab">
                  <i class="bi bi-tags"></i> Categories
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#content" data-bs-toggle="tab">
                  <i class="bi bi-pencil-square"></i> Content
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#profile" data-bs-toggle="tab">
                  <i class="bi bi-person"></i> Profile
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
        <div class="tab-content">
          <!-- Dashboard Tab -->
          <div class="tab-pane fade show active" id="dashboard">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">Dashboard</h1>
              <div class="btn-toolbar mb-2 mb-md-0">
                <div class="btn-group me-2">
                  <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
                </div>
              </div>
            </div>
            
            <!-- Stats Cards -->
            <div class="row">
              <div class="col-md-3">
                <div class="card dashboard-card">
                  <div class="card-body stats-card">
                    <div class="stats-number"><%= products.length %></div>
                    <div class="stats-label">Total Products</div>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card dashboard-card">
                  <div class="card-body stats-card">
                    <div class="stats-number"><%= posts.length %></div>
                    <div class="stats-label">Total Posts</div>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card dashboard-card">
                  <div class="card-body stats-card">
                    <div class="stats-number"><%= categories.length %></div>
                    <div class="stats-label">Total Categories</div>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card dashboard-card">
                  <div class="card-body stats-card">
                    <div class="stats-number">12</div>
                    <div class="stats-label">Recent Orders</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="row mt-4">
              <div class="col-md-6">
                <div class="card dashboard-card">
                  <div class="card-header">Recent Products</div>
                  <div class="card-body">
                    <% if (products.length > 0) { %>
                      <div class="list-group list-group-flush">
                        <% products.slice(0, 5).forEach(product => { %>
                          <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                              <h6 class="mb-1"><%= product.name %></h6>
                              <small class="text-dark">Added recently</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">$<%= product.price %></span>
                          </div>
                        <% }) %>
                      </div>
                    <% } else { %>
                      <div class="empty-state">
                        <i class="bi bi-box"></i>
                        <p>No products yet</p>
                        <a href="#products" class="btn btn-primary btn-sm" data-bs-toggle="tab">Add Product</a>
                      </div>
                    <% } %>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="card dashboard-card">
                  <div class="card-header">Recent Posts</div>
                  <div class="card-body">
                    <% if (posts.length > 0) { %>
                      <div class="list-group list-group-flush">
                        <% posts.slice(0, 5).forEach(post => { %>
                          <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                              <h6 class="mb-1"><%= post.title %></h6>
                              <small class="text-dark">Posted recently</small>
                            </div>
                            <span class="badge bg-secondary rounded-pill">View</span>
                          </div>
                        <% }) %>
                      </div>
                    <% } else { %>
                      <div class="empty-state">
                        <i class="bi bi-file-text"></i>
                        <p>No posts yet</p>
                        <a href="#posts" class="btn btn-primary btn-sm" data-bs-toggle="tab">Add Post</a>
                      </div>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Products Tab -->
          <div class="tab-pane fade" id="products">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">Products</h1>
            </div>
            
            <ul class="nav nav-tabs mb-4">
              <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#add-product">Add Product</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#manage-products">Manage Products</a>
              </li>
            </ul>
            
            <div class="tab-content">
              <div class="tab-pane fade show active" id="add-product">
                <div class="form-section">
                  <h3>Add New Product</h3>
                  <form method="POST" action="/admin/products" enctype="multipart/form-data">
                    <%- include('./components/csrf_input') %>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="productName" class="form-label">Product Name</label>
                          <input type="text" class="form-control" id="productName" name="name" required>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="productPrice" class="form-label">Price</label>
                          <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="productPrice" name="price" step="0.01" min="0">
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="mb-3">
                      <label for="productDesc" class="form-label">Description</label>
                      <textarea class="form-control" id="productDesc" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="productCategory" class="form-label">Category</label>
                          <select class="form-control" id="productCategory" name="category">
                            <% categories.filter(c => c.type === 'product').forEach(cat => { %>
                              <option value="<%= cat._id %>"><%= cat.name %></option>
                            <% }) %>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="productImage" class="form-label">Product Image</label>
                          <input type="file" class="form-control" id="productImage" name="image" accept="image/*">
                        </div>
                      </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-plus-circle"></i> Add Product
                    </button>
                  </form>
                </div>
              </div>
              
              <div class="tab-pane fade" id="manage-products">
                <div class="form-section">
                  <h3>Manage Products</h3>
                  <% if (products.length > 0) { %>
                    <div class="table-responsive">
                      <table class="table table-hover">
                        <thead>
                          <tr>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Category</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% products.forEach(product => { %>
                            <tr>
                              <td><%= product.name %></td>
                              <td>$<%= product.price %></td>
                              <td>
                                <% const cat = product.category && categories.find(c => c._id.toString() === product.category.toString()) %>
                                <%= cat ? cat.name : 'Uncategorized' %>
                              </td>
                              <td>
                                <button class="btn btn-sm btn-outline-primary action-btn" data-bs-toggle="modal" data-bs-target="#editProductModal<%= product._id %>">
                                  <i class="bi bi-pencil"></i> Edit
                                </button>
                                <form method="POST" action="/admin/products/<%= product._id %>/delete" class="d-inline">
                                  <%- include('./components/csrf_input') %>
                                  <button type="submit" class="btn btn-sm btn-outline-danger action-btn"
                                          onclick="return confirm('Are you sure you want to delete this product?')">
                                    <i class="bi bi-trash"></i> Delete
                                  </button>
                                </form>
                              </td>
                            </tr>
                            <!-- Edit Product Modal -->
                            <div class="modal fade" id="editProductModal<%= product._id %>" tabindex="-1">
                              <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h5 class="modal-title">Edit Product</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                  </div>
                                  <form method="POST" action="/admin/products/<%= product._id %>/edit" enctype="multipart/form-data">
                                    <%- include('./components/csrf_input') %>
                                    <div class="modal-body">
                                      <div class="row">
                                        <div class="col-md-6">
                                          <div class="mb-3">
                                            <label class="form-label">Product Name</label>
                                            <input type="text" class="form-control" name="name" value="<%= product.name %>" required>
                                          </div>
                                        </div>
                                        <div class="col-md-6">
                                          <div class="mb-3">
                                            <label class="form-label">Price</label>
                                            <div class="input-group">
                                              <span class="input-group-text">$</span>
                                              <input type="number" class="form-control" name="price" value="<%= product.price %>" step="0.01" min="0">
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                      <div class="mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-control" name="description" rows="3"><%= product.description %></textarea>
                                      </div>
                                      <div class="row">
                                        <div class="col-md-6">
                                          <div class="mb-3">
                                            <label class="form-label">Category</label>
                                            <select class="form-control" name="category">
                                              <% categories.filter(c => c.type === 'product').forEach(cat => { %>
                                                <option value="<%= cat._id %>" <%= cat._id.toString() === product.category.toString() ? 'selected' : '' %>><%= cat.name %></option>
                                              <% }) %>
                                            </select>
                                          </div>
                                        </div>
                                        <div class="col-md-6">
                                          <div class="mb-3">
                                            <label class="form-label">New Image (optional)</label>
                                            <input type="file" class="form-control" name="image" accept="image/*">
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                    <div class="modal-footer">
                                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                      <button type="submit" class="btn btn-primary">Update Product</button>
                                    </div>
                                  </form>
                                </div>
                              </div>
                            </div>
                          <% }) %>
                        </tbody>
                      </table>
                    </div>
                  <% } else { %>
                    <div class="empty-state">
                      <i class="bi bi-box"></i>
                      <p>No products added yet</p>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Posts Tab -->
          <div class="tab-pane fade" id="posts">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">Posts</h1>
            </div>
            
            <ul class="nav nav-tabs mb-4">
              <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#add-post">Add Post</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#manage-posts">Manage Posts</a>
              </li>
            </ul>
            
            <div class="tab-content">
              <div class="tab-pane fade show active" id="add-post">
                <div class="form-section">
                  <h3>Add New Post</h3>
                  <form method="POST" action="/admin/posts" enctype="multipart/form-data">
                    <%- include('./components/csrf_input') %>
                    <div class="mb-3">
                      <label for="postTitle" class="form-label">Title</label>
                      <input type="text" class="form-control" id="postTitle" name="title" required>
                    </div>
                    
                    <div class="mb-3">
                      <label for="postContent" class="form-label">Content</label>
                      <textarea class="form-control" id="postContent" name="content" rows="5" required></textarea>
                    </div>
                    
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="postCategory" class="form-label">Category</label>
                          <select class="form-control" id="postCategory" name="category">
                            <% categories.filter(c => c.type === 'post').forEach(cat => { %>
                              <option value="<%= cat._id %>"><%= cat.name %></option>
                            <% }) %>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="postImage" class="form-label">Featured Image</label>
                          <input type="file" class="form-control" id="postImage" name="image" accept="image/*">
                        </div>
                      </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-plus-circle"></i> Add Post
                    </button>
                  </form>
                </div>
              </div>
              
              <div class="tab-pane fade" id="manage-posts">
                <div class="form-section">
                  <h3>Manage Posts</h3>
                  <% if (posts.length > 0) { %>
                    <div class="table-responsive">
                      <table class="table table-hover">
                        <thead>
                          <tr>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Date</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% posts.forEach(post => { %>
                            <tr>
                              <td><%= post.title %></td>
                              <td>
                                <% const cat = post.category && categories.find(c => c._id.toString() === post.category.toString()) %>
                                <%= cat ? cat.name : 'Uncategorized' %>
                              </td>
                              <td><%= new Date(post.createdAt).toLocaleDateString() %></td>
                              <td>
                                <button class="btn btn-sm btn-outline-primary action-btn" data-bs-toggle="modal" data-bs-target="#editPostModal<%= post._id %>">
                                  <i class="bi bi-pencil"></i> Edit
                                </button>
                                <form method="POST" action="/admin/posts/<%= post._id %>/delete" class="d-inline">
                                  <%- include('./components/csrf_input') %>
                                  <button type="submit" class="btn btn-sm btn-outline-danger action-btn"
                                          onclick="return confirm('Are you sure you want to delete this post?')">
                                    <i class="bi bi-trash"></i> Delete
                                  </button>
                                </form>
                              </td>
                            </tr>
                            <!-- Edit Post Modal -->
                            <div class="modal fade" id="editPostModal<%= post._id %>" tabindex="-1">
                              <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h5 class="modal-title">Edit Post</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                  </div>
                                  <form method="POST" action="/admin/posts/<%= post._id %>/edit" enctype="multipart/form-data">
                                    <%- include('./components/csrf_input') %>
                                    <div class="modal-body">
                                      <div class="mb-3">
                                        <label class="form-label">Title</label>
                                        <input type="text" class="form-control" name="title" value="<%= post.title %>" required>
                                      </div>
                                      <div class="mb-3">
                                        <label class="form-label">Content</label>
                                        <textarea class="form-control" name="content" rows="5" required><%= post.content %></textarea>
                                      </div>
                                      <div class="row">
                                        <div class="col-md-6">
                                          <div class="mb-3">
                                            <label class="form-label">Category</label>
                                            <select class="form-control" name="category">
                                              <% categories.filter(c => c.type === 'post').forEach(cat => { %>
                                                <option value="<%= cat._id %>" <%= post.category && cat._id.toString() === post.category.toString() ? 'selected' : '' %>><%= cat.name %></option>
                                              <% }) %>
                                            </select>
                                          </div>
                                        </div>
                                        <div class="col-md-6">
                                          <div class="mb-3">
                                            <label class="form-label">New Image (optional)</label>
                                            <input type="file" class="form-control" name="image" accept="image/*">
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                    <div class="modal-footer">
                                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                      <button type="submit" class="btn btn-primary">Update Post</button>
                                    </div>
                                  </form>
                                </div>
                              </div>
                            </div>
                          <% }) %>
                        </tbody>
                      </table>
                    </div>
                  <% } else { %>
                    <div class="empty-state">
                      <i class="bi bi-file-text"></i>
                      <p>No posts added yet</p>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Categories Tab -->
          <div class="tab-pane fade" id="categories">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">Categories</h1>
            </div>
            
            <ul class="nav nav-tabs mb-4">
              <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#add-category">Add Category</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#manage-categories">Manage Categories</a>
              </li>
            </ul>
            
            <div class="tab-content">
              <div class="tab-pane fade show active" id="add-category">
                <div class="form-section">
                  <h3>Add New Category</h3>
                  <form method="POST" action="/admin/categories">
                    <%- include('./components/csrf_input') %>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="catName" class="form-label">Name</label>
                          <input type="text" class="form-control" id="catName" name="name" required>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="catType" class="form-label">Type</label>
                          <select class="form-control" id="catType" name="type" required>
                            <option value="product">Product</option>
                            <option value="post">Post</option>
                          </select>
                        </div>
                      </div>
                    </div>
                    
                    <div class="mb-3">
                      <label for="catDesc" class="form-label">Description</label>
                      <textarea class="form-control" id="catDesc" name="description" rows="3"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-plus-circle"></i> Add Category
                    </button>
                  </form>
                </div>
              </div>
              
              <div class="tab-pane fade" id="manage-categories">
                <div class="form-section">
                  <h3>Manage Categories</h3>
                  <% if (categories.length > 0) { %>
                    <div class="table-responsive">
                      <table class="table table-hover">
                        <thead>
                          <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% categories.forEach(cat => { %>
                            <tr>
                              <td><%= cat.name %></td>
                              <td>
                                <span class="badge <%= cat.type === 'product' ? 'bg-primary' : 'bg-info' %>">
                                  <%= cat.type %>
                                </span>
                              </td>
                              <td><%= cat.description %></td>
                              <td>
                                <button class="btn btn-sm btn-outline-primary action-btn" data-bs-toggle="modal" data-bs-target="#editCategoryModal<%= cat._id %>">
                                  <i class="bi bi-pencil"></i> Edit
                                </button>
                                <form method="POST" action="/admin/categories/<%= cat._id %>/delete" class="d-inline">
                                  <%- include('./components/csrf_input') %>
                                  <button type="submit" class="btn btn-sm btn-outline-danger action-btn"
                                          onclick="return confirm('Are you sure you want to delete this category?')">
                                    <i class="bi bi-trash"></i> Delete
                                  </button>
                                </form>
                              </td>
                            </tr>
                            <!-- Edit Category Modal -->
                            <div class="modal fade" id="editCategoryModal<%= cat._id %>" tabindex="-1">
                              <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h5 class="modal-title">Edit Category</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                  </div>
                                  <form method="POST" action="/admin/categories/<%= cat._id %>/edit">
                                    <%- include('./components/csrf_input') %>
                                    <div class="modal-body">
                                      <div class="row">
                                        <div class="col-md-6">
                                          <div class="mb-3">
                                            <label class="form-label">Name</label>
                                            <input type="text" class="form-control" name="name" value="<%= cat.name %>" required>
                                          </div>
                                        </div>
                                        <div class="col-md-6">
                                          <div class="mb-3">
                                            <label class="form-label">Type</label>
                                            <select class="form-control" name="type" required>
                                              <option value="product" <%= cat.type === 'product' ? 'selected' : '' %>>Product</option>
                                              <option value="post" <%= cat.type === 'post' ? 'selected' : '' %>>Post</option>
                                            </select>
                                          </div>
                                        </div>
                                      </div>
                                      <div class="mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-control" name="description" rows="3"><%= cat.description %></textarea>
                                      </div>
                                    </div>
                                    <div class="modal-footer">
                                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                      <button type="submit" class="btn btn-primary">Update Category</button>
                                    </div>
                                  </form>
                                </div>
                              </div>
                            </div>
                          <% }) %>
                        </tbody>
                      </table>
                    </div>
                  <% } else { %>
                    <div class="empty-state">
                      <i class="bi bi-tags"></i>
                      <p>No categories added yet</p>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
          </div>

          <!-- Content Tab -->
          <div class="tab-pane fade" id="content">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">Website Content</h1>
            </div>

            <div class="row">
              <div class="col-md-12">
                <div class="card">
                  <div class="card-header">
                    <h5 class="mb-0">Edit Website Content</h5>
                  </div>
                  <div class="card-body">
                    <% if (typeof success !== 'undefined' && success) { %>
                      <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <%= success %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                      </div>
                    <% } %>
                    <% if (typeof error !== 'undefined' && error) { %>
                      <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <%= error %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                      </div>
                    <% } %>

                    <form method="POST" action="/admin/content">
                      <%- include('./components/csrf_input') %>
                      <h4 class="mb-3">Hero Section</h4>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="heroTitle" class="form-label">Hero Title</label>
                            <input type="text" class="form-control" id="heroTitle" name="heroTitle" value="<%= typeof content !== 'undefined' && content.heroTitle ? content.heroTitle : 'Ingrid Chemicals Pvt Ltd' %>" placeholder="Ingrid Chemicals Pvt Ltd" required>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="heroSubtitle" class="form-label">Hero Subtitle</label>
                            <input type="text" class="form-control" id="heroSubtitle" name="heroSubtitle" value="<%= typeof content !== 'undefined' && content.heroSubtitle ? content.heroSubtitle : '' %>" placeholder="Leading provider of high-quality mining chemicals and industrial equipment with over 20 years of industry expertise and innovation." required>
                          </div>
                        </div>
                      </div>

                      <h4 class="mb-3 mt-4">About Section</h4>
                      <div class="mb-3">
                        <label for="aboutTitle" class="form-label">About Title</label>
                        <input type="text" class="form-control" id="aboutTitle" name="aboutTitle" value="<%= typeof content !== 'undefined' && content.aboutTitle ? content.aboutTitle : '' %>" placeholder="About Ingrid Chemicals" required>
                      </div>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="aboutText1" class="form-label">About Text 1</label>
                            <textarea class="form-control wysiwyg-textarea" id="aboutText1" name="aboutText1" rows="4" required><%= typeof content !== 'undefined' && content.aboutText1 ? content.aboutText1 : '' %></textarea>
                            <div class="form-text">Start typing to enable rich text editor</div>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="aboutText2" class="form-label">About Text 2</label>
                            <textarea class="form-control wysiwyg-textarea" id="aboutText2" name="aboutText2" rows="4" required><%= typeof content !== 'undefined' && content.aboutText2 ? content.aboutText2 : '' %></textarea>
                            <div class="form-text">Start typing to enable rich text editor</div>
                          </div>
                        </div>
                      </div>

                      <h4 class="mb-3 mt-4">Contact Information</h4>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="contactAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="contactAddress" name="contactAddress" rows="3" placeholder="123 Industrial Park, Mining City, MC 12345, United States" required><%= typeof content !== 'undefined' && content.contactAddress ? content.contactAddress : '' %></textarea>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="contactPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="contactPhone" name="contactPhone" value="<%= typeof content !== 'undefined' && content.contactPhone ? content.contactPhone : '' %>" placeholder="+1 (555) 123-4567" required>
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="contactEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="contactEmail" name="contactEmail" value="<%= typeof content !== 'undefined' && content.contactEmail ? content.contactEmail : '' %>" required>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="contactHours" class="form-label">Business Hours</label>
                            <input type="text" class="form-control" id="contactHours" name="contactHours" value="<%= typeof content !== 'undefined' && content.contactHours ? content.contactHours : '' %>" required>
                          </div>
                        </div>
                      </div>

                      <!-- Business Hours Widget -->
                      <h4 class="mb-3 mt-4">Business Hours Widget</h4>
                      <div class="border rounded p-3 mb-3">
                        <p class="text-muted small">Configure regular weekly hours and special holiday closures. This will replace the simple text input above.</p>

                        <!-- Regular Hours -->
                        <h5 class="mb-3">Regular Weekly Hours</h5>
                        <div class="row">
                          <% const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']; %>
                          <% const dayLabels = { monday: 'Monday', tuesday: 'Tuesday', wednesday: 'Wednesday', thursday: 'Thursday', friday: 'Friday', saturday: 'Saturday', sunday: 'Sunday' }; %>
                          <% const defaultHours = {
                            monday: { open: '08:00', close: '18:00', closed: false },
                            tuesday: { open: '08:00', close: '18:00', closed: false },
                            wednesday: { open: '08:00', close: '18:00', closed: false },
                            thursday: { open: '08:00', close: '18:00', closed: false },
                            friday: { open: '08:00', close: '18:00', closed: false },
                            saturday: { open: '09:00', close: '14:00', closed: false },
                            sunday: { open: '08:00', close: '18:00', closed: true }
                          }; %>
                          <% days.forEach(day => { %>
                            <% const dayData = typeof content !== 'undefined' && content.businessHours && content.businessHours.days ? content.businessHours.days.find(d => d.day === day) : null; %>
                            <% const defaults = defaultHours[day]; %>
                            <div class="col-md-6 mb-3">
                              <div class="card">
                                <div class="card-body p-3">
                                  <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong><%= dayLabels[day] %></strong>
                                    <div class="form-check">
                                      <input class="form-check-input" type="checkbox" id="closed_<%= day %>" name="businessHours.days.<%= day %>.isClosed" <%= dayData ? (dayData.isClosed ? 'checked' : '') : (defaults.closed ? 'checked' : '') %>>
                                      <label class="form-check-label small" for="closed_<%= day %>">Closed</label>
                                    </div>
                                  </div>
                                  <div class="row">
                                    <div class="col-6">
                                      <label class="form-label small">Open</label>
                                      <input type="time" class="form-control form-control-sm" name="businessHours.days.<%= day %>.openTime" value="<%= dayData ? dayData.openTime : defaults.open %>" <%= (dayData && dayData.isClosed) || (!dayData && defaults.closed) ? 'disabled' : '' %>>
                                    </div>
                                    <div class="col-6">
                                      <label class="form-label small">Close</label>
                                      <input type="time" class="form-control form-control-sm" name="businessHours.days.<%= day %>.closeTime" value="<%= dayData ? dayData.closeTime : defaults.close %>" <%= (dayData && dayData.isClosed) || (!dayData && defaults.closed) ? 'disabled' : '' %>>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          <% }); %>
                        </div>

                        <!-- Holidays/Special Closures -->
                        <h5 class="mb-3">Holidays & Special Closures</h5>
                        <div id="holidaysContainer">
                          <% if (typeof content !== 'undefined' && content.businessHours && content.businessHours.holidays) { %>
                            <% content.businessHours.holidays.forEach((holiday, index) => { %>
                              <div class="holiday-item border rounded p-3 mb-2">
                                <div class="row">
                                  <div class="col-md-4">
                                    <label class="form-label small">Holiday Name</label>
                                    <input type="text" class="form-control form-control-sm" name="holidayNames" value="<%= holiday.name %>" required>
                                  </div>
                                  <div class="col-md-3">
                                    <label class="form-label small">Date</label>
                                    <input type="date" class="form-control form-control-sm" name="holidayDates" value="<%= holiday.date.toISOString().split('T')[0] %>" required>
                                  </div>
                                  <div class="col-md-2">
                                    <label class="form-label small">Closed?</label>
                                    <div class="form-check mt-2">
                                      <input class="form-check-input holiday-closed" type="checkbox" name="holidayClosed" <%= holiday.isClosed ? 'checked' : '' %>>
                                    </div>
                                  </div>
                                  <div class="col-md-2">
                                    <label class="form-label small">Open Time</label>
                                    <input type="time" class="form-control form-control-sm holiday-open-time" name="holidayOpenTimes" value="<%= !holiday.isClosed && holiday.customHours ? holiday.customHours.openTime : '08:00' %>" <%= holiday.isClosed ? 'disabled' : '' %>>
                                  </div>
                                  <div class="col-md-1">
                                    <label class="form-label small">&nbsp;</label>
                                    <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-holiday">
                                      <i class="bi bi-trash"></i>
                                    </button>
                                  </div>
                                </div>
                              </div>
                            <% }); %>
                          <% } %>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="addHolidayBtn">
                          <i class="bi bi-plus-circle"></i> Add Holiday
                        </button>
                      </div>

                      <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Update Content
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Profile Tab -->
          <div class="tab-pane fade" id="profile">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">Profile Settings</h1>
            </div>

            <div class="row">
              <div class="col-md-8">
                <div class="card">
                  <div class="card-header">
                    <h5 class="mb-0">Update Profile Information</h5>
                  </div>
                  <div class="card-body">
                    <% if (typeof success !== 'undefined' && success) { %>
                      <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <%= success %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                      </div>
                    <% } %>
                    <% if (typeof error !== 'undefined' && error) { %>
                      <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <%= error %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                      </div>
                    <% } %>

                    <form method="POST" action="/admin/profile/update">
                      <%- include('./components/csrf_input') %>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="firstName" name="firstName" value="<%= user.firstName %>" required>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="lastName" name="lastName" value="<%= user.lastName %>" required>
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" name="username" value="<%= user.username %>" required>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="mb-3">
                          <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" value="<%= user.email %>" required>
                          </div>
                        </div>
                      </div>

                      <div class="row">
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" name="currentPassword" placeholder="Enter current password to change">
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" name="newPassword" placeholder="Enter new password">
                          </div>
                        </div>
                      </div>

                      <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" placeholder="Confirm new password">
                      </div>

                      <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Update Profile
                      </button>
                    </form>
                  </div>
                </div>
              </div>

              <div class="col-md-4">
                <div class="card">
                  <div class="card-header">
                    <h5 class="mb-0">Account Information</h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <strong>Role:</strong>
                      <span class="badge <%= user.role === 'superadmin' ? 'bg-danger' : user.role === 'admin' ? 'bg-warning' : 'bg-info' %>">
                        <%= user.role %>
                      </span>
                    </div>
                    <div class="mb-3">
                      <strong>Member Since:</strong>
                      <br>
                      <small class="text-muted"><%= new Date(user.createdAt).toLocaleDateString() %></small>
                    </div>
                    <div class="mb-3">
                      <strong>Last Login:</strong>
                      <br>
                      <small class="text-muted"><%= user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'Never' %></small>
                    </div>
                    <div class="mb-3">
                      <strong>Status:</strong>
                      <span class="badge <%= user.isActive ? 'bg-success' : 'bg-secondary' %>">
                        <%= user.isActive ? 'Active' : 'Inactive' %>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Logout Confirmation Modal -->
  <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="logoutModalLabel">Confirm Logout</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to log out?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <form method="POST" action="/admin/logout" class="d-inline">
            <%- include('./components/csrf_input') %>
            <button type="submit" class="btn btn-primary" id="confirmLogoutBtn">
              <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
              <span class="button-text">OK</span>
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Dark Mode Toggle - Moved to bottom -->
  <div class="dark-mode-toggle fixed-bottom-end" id="darkModeToggle" title="Toggle Dark Mode" style="margin: 20px; z-index: 1050;">
    <i class="bi bi-moon-fill" id="darkModeIcon"></i>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Global fetch wrapper: if a fetch call returns 401/403, redirect to login
    // but avoid redirect during an explicit logout submit (race condition)
    (function() {
      window.__isLoggingOut = false;
      // Mark logging out when logout form is submitted
      try {
        document.querySelectorAll('form[action="/admin/logout"]').forEach(form => {
          form.addEventListener('submit', function() {
            window.__isLoggingOut = true;
          });
        });
      } catch (e) {
        // ignore
      }

      const _fetch = window.fetch;
      window.fetch = function(resource, init) {
        return _fetch(resource, init).then(res => {
          if ((res.status === 401 || res.status === 403) && !window.__isLoggingOut) {
            // Likely CSRF or session expired. Redirect to login to re-authenticate.
            window.location.href = '/admin/login';
            return Promise.reject(new Error('Unauthorized'));
          }
          return res;
        }).catch(err => {
          // swallow network/errors during logout to avoid UI noise
          if (window.__isLoggingOut) return new Promise(() => {});
          throw err;
        });
      };
    })();
    // Dark mode toggle functionality
    const darkModeToggle = document.getElementById('darkModeToggle');
    const darkModeIcon = document.getElementById('darkModeIcon');
    const body = document.body;

    // Check for saved theme preference or default to light mode
    const currentTheme = localStorage.getItem('theme') || 'light';
    if (currentTheme === 'dark') {
      body.classList.add('dark-mode');
      darkModeIcon.classList.remove('bi-moon-fill');
      darkModeIcon.classList.add('bi-sun-fill');
    }

    darkModeToggle.addEventListener('click', function() {
      body.classList.toggle('dark-mode');

      if (body.classList.contains('dark-mode')) {
        localStorage.setItem('theme', 'dark');
        darkModeIcon.classList.remove('bi-moon-fill');
        darkModeIcon.classList.add('bi-sun-fill');
      } else {
        localStorage.setItem('theme', 'light');
        darkModeIcon.classList.remove('bi-sun-fill');
        darkModeIcon.classList.add('bi-moon-fill');
      }
    });

    // Tab persistence and activation
    document.addEventListener('DOMContentLoaded', function() {
      // Activate the correct tab based on URL hash
      if (window.location.hash) {
        const triggerEl = document.querySelector(`a[href="${window.location.hash}"]`);
        if (triggerEl) {
          const tab = new bootstrap.Tab(triggerEl);
          tab.show();
        }
      }

      // Update URL when tabs are clicked
      const tabLinks = document.querySelectorAll('a[data-bs-toggle="tab"]');
      tabLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          if (this.getAttribute('href') && this.getAttribute('href').startsWith('#')) {
            window.location.hash = this.getAttribute('href');
          }
        });
      });

      // When main tab is shown, trigger the active sub-tab
      document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(link => {
        link.addEventListener('shown.bs.tab', function() {
          const mainTabContent = document.querySelector(this.getAttribute('href'));
          if (mainTabContent) {
            const activeSubTab = mainTabContent.querySelector('.nav-tabs .nav-link.active');
            if (activeSubTab) {
              const subTab = new bootstrap.Tab(activeSubTab);
              subTab.show();
            }
          }
        });
      });

      // Add confirmation for delete actions
      const deleteForms = document.querySelectorAll('form[action*="/delete"]');
      deleteForms.forEach(form => {
        form.addEventListener('submit', function(e) {
          if (!confirm('Are you sure you want to delete this item?')) {
            e.preventDefault();
          }
        });
      });

      // Inject CSRF token into POST forms if available
      (function injectCsrf() {
        try {
          const holder = document.getElementById('csrf-holder');
          if (!holder) return;
          const token = holder.getAttribute('data-csrf') || '';
          if (!token) return;
          document.querySelectorAll('form[method="POST"]').forEach(form => {
            if (!form.querySelector('input[name="_csrf"]')) {
              const input = document.createElement('input');
              input.type = 'hidden';
              input.name = '_csrf';
              input.value = token;
              form.prepend(input);
            }
          });
        } catch (e) {
          console.error('CSRF injection failed', e);
        }
      })();

      // Business Hours Widget functionality
      const addHolidayBtn = document.getElementById('addHolidayBtn');
      const holidaysContainer = document.getElementById('holidaysContainer');

      if (addHolidayBtn && holidaysContainer) {
        addHolidayBtn.addEventListener('click', function() {
          const holidayItem = document.createElement('div');
          holidayItem.className = 'holiday-item border rounded p-3 mb-2';
          holidayItem.innerHTML = `
            <div class="row">
              <div class="col-md-4">
                <label class="form-label small">Holiday Name</label>
                <input type="text" class="form-control form-control-sm" name="holidayNames" required>
              </div>
              <div class="col-md-3">
                <label class="form-label small">Date</label>
                <input type="date" class="form-control form-control-sm" name="holidayDates" required>
              </div>
              <div class="col-md-2">
                <label class="form-label small">Closed?</label>
                <div class="form-check mt-2">
                  <input class="form-check-input holiday-closed" type="checkbox" name="holidayClosed">
                </div>
              </div>
              <div class="col-md-2">
                <label class="form-label small">Open Time</label>
                <input type="time" class="form-control form-control-sm holiday-open-time" name="holidayOpenTimes" value="08:00">
              </div>
              <div class="col-md-1">
                <label class="form-label small">&nbsp;</label>
                <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-holiday">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          `;
          holidaysContainer.appendChild(holidayItem);
          attachHolidayEventListeners(holidayItem);
        });

        // Function to attach event listeners to holiday items
        function attachHolidayEventListeners(holidayItem) {
          const removeBtn = holidayItem.querySelector('.remove-holiday');
          const closedCheckbox = holidayItem.querySelector('.holiday-closed');
          const openTimeInput = holidayItem.querySelector('.holiday-open-time');

          if (removeBtn) {
            removeBtn.addEventListener('click', function() {
              holidayItem.remove();
            });
          }

          if (closedCheckbox && openTimeInput) {
            closedCheckbox.addEventListener('change', function() {
              openTimeInput.disabled = this.checked;
            });
          }
        }

        // Attach listeners to existing holiday items
        document.querySelectorAll('.holiday-item').forEach(attachHolidayEventListeners);
      }

      // Handle closed day checkboxes for regular hours
      document.querySelectorAll('input[type="checkbox"][id^="closed_"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const day = this.id.replace('closed_', '');
          const openTimeInput = document.querySelector(`input[name="businessHours.days.${day}.openTime"]`);
          const closeTimeInput = document.querySelector(`input[name="businessHours.days.${day}.closeTime"]`);

          if (openTimeInput && closeTimeInput) {
            openTimeInput.disabled = this.checked;
            closeTimeInput.disabled = this.checked;
          }
        });
      });

      // Collapse sidebar on mobile when a sidebar link is clicked
      document.querySelectorAll('#sidebar .nav-link').forEach(link => {
        link.addEventListener('click', function() {
          const sidebar = document.getElementById('sidebar');
          if (sidebar && sidebar.classList.contains('show')) {
            const bsCollapse = bootstrap.Collapse.getInstance(sidebar) || new bootstrap.Collapse(sidebar);
            bsCollapse.hide();
          }
        });
      });
    });
  </script>
</body>
</html>