<!DOCTYPE html>
<html lang="en">
<%- include('./components/head', { title: 'Super Admin Dashboard - Ingrid Chemicals' }) %>
<style>
body.super-admin-dashboard.dark-mode {
  background-color: #1a1a1a;
  color: #ffffff;
}
body.super-admin-dashboard.dark-mode .navbar {
  background: linear-gradient(135deg, #2c2c2c, #1a1a1a) !important;
}
body.super-admin-dashboard.dark-mode .sidebar {
  background-color: #2c2c2c;
}
body.super-admin-dashboard.dark-mode .main-content {
  background-color: #1a1a1a;
}
body.super-admin-dashboard.dark-mode .card {
  background-color: #2c2c2c;
  border-color: #404040;
  color: #ffffff;
}
body.super-admin-dashboard.dark-mode .card-header {
  background-color: #333333;
  border-bottom-color: #404040;
  color: #ffffff;
}
body.super-admin-dashboard.dark-mode .table {
  color: #ffffff;
}
body.super-admin-dashboard.dark-mode .table thead th {
  background-color: #333333;
  border-color: #404040;
  color: #ffffff;
}
body.super-admin-dashboard.dark-mode .table tbody tr {
  background-color: #2c2c2c;
  border-color: #404040;
}
body.super-admin-dashboard.dark-mode .table tbody tr:hover {
  background-color: #333333;
}
body.super-admin-dashboard.dark-mode .form-control {
  background-color: #333333;
  border-color: #404040;
  color: #ffffff;
}
body.super-admin-dashboard.dark-mode .form-control:focus {
  background-color: #333333;
  border-color: #555555;
  color: #ffffff;
}
body.super-admin-dashboard.dark-mode .form-label {
  color: #ffffff;
}
body.super-admin-dashboard.dark-mode .btn-outline-primary {
  color: #ffffff;
  border-color: #ffffff;
}
body.super-admin-dashboard.dark-mode .btn-outline-primary:hover {
  background-color: #ffffff;
  color: #000000;
}
body.super-admin-dashboard.dark-mode .btn-outline-danger {
  color: #ff6b6b;
  border-color: #ff6b6b;
}
body.super-admin-dashboard.dark-mode .btn-outline-danger:hover {
  background-color: #ff6b6b;
  color: #ffffff;
}
body.super-admin-dashboard.dark-mode .text-dark {
  color: #cccccc !important;
}
body.super-admin-dashboard.dark-mode .text-muted {
  color: #aaaaaa !important;
}
body.super-admin-dashboard.dark-mode .border-bottom {
  border-color: #404040 !important;
}
body.super-admin-dashboard.dark-mode .list-group-item {
  background-color: #2c2c2c;
  border-color: #404040;
  color: #ffffff;
}
body.super-admin-dashboard.dark-mode .list-group-item:hover {
  background-color: #333333;
}
body.super-admin-dashboard.dark-mode .empty-state {
  color: #cccccc;
}
body.super-admin-dashboard.dark-mode .empty-state i {
  color: #666666;
}
body.super-admin-dashboard.dark-mode .modal-content {
  background-color: #2c2c2c;
  color: #ffffff;
}
body.super-admin-dashboard.dark-mode .modal-header {
  border-bottom-color: #404040;
}
body.super-admin-dashboard.dark-mode .modal-footer {
  border-top-color: #404040;
}
body.super-admin-dashboard.dark-mode .alert-success {
  background-color: #2d5a2d;
  border-color: #4caf50;
  color: #c8e6c9;
}
body.super-admin-dashboard.dark-mode .alert-danger {
  background-color: #5a2d2d;
  border-color: #f44336;
  color: #ffcdd2;
}
body.super-admin-dashboard:not(.dark-mode) .nav-tabs .nav-link {
  color: #495057 !important;
}
body.super-admin-dashboard:not(.dark-mode) .nav-tabs .nav-link.active {
  color: #dc3545 !important;
}

/* Dark Mode Toggle Styles */
.dark-mode-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  background-color: #dc3545;
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  transition: background-color 0.3s, transform 0.2s;
  z-index: 1050;
}

.dark-mode-toggle:hover {
  background-color: #c82333;
  transform: scale(1.1);
}

.dark-mode-toggle.dark-mode-active {
  background-color: #333333;
}

.dark-mode-toggle.dark-mode-active:hover {
  background-color: #555555;
}
</style>
<body class="super-admin-dashboard">
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-danger">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">
        <i class="bi bi-shield-lock"></i> Super Admin - Ingrid Chemicals
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="/" target="_blank">
              <i class="bi bi-eye"></i> View Site
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin">
              <i class="bi bi-speedometer2"></i> Regular Admin
            </a>
          </li>
          <li class="nav-item">
            <button type="button" class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#logoutModal">
              <i class="bi bi-box-arrow-right"></i> Logout
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 col-lg-2 d-md-block sidebar collapse bg-danger">
        <div class="position-sticky pt-3">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active text-white" href="#dashboard" data-bs-toggle="tab">
                <i class="bi bi-speedometer2"></i> Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white" href="#database" data-bs-toggle="tab">
                <i class="bi bi-database"></i> Database
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white" href="#users" data-bs-toggle="tab">
                <i class="bi bi-people"></i> Users
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white" href="#storage" data-bs-toggle="tab">
                <i class="bi bi-folder"></i> Storage
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white" href="#logs" data-bs-toggle="tab">
                <i class="bi bi-journal-text"></i> Logs
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white" href="#user-paths" data-bs-toggle="tab">
                <i class="bi bi-diagram-3"></i> User Paths
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Main Content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
        <div class="tab-content">
          <!-- Dashboard Tab -->
          <div class="tab-pane fade show active" id="dashboard">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">Super Admin Dashboard</h1>
            </div>

            <!-- Stats Cards -->
            <div class="row">
              <div class="col-md-2">
                <div class="card dashboard-card">
                  <div class="card-body stats-card">
                    <div class="stats-number"><%= users.length %></div>
                    <div class="stats-label">Total Users</div>
                  </div>
                </div>
              </div>
              <div class="col-md-2">
                <div class="card dashboard-card">
                  <div class="card-body stats-card">
                    <div class="stats-number"><%= users.filter(u => u.isActive).length %></div>
                    <div class="stats-label">Active Users</div>
                  </div>
                </div>
              </div>
              <div class="col-md-2">
                <div class="card dashboard-card">
                  <div class="card-body stats-card">
                    <div class="stats-number"><%= products.length %></div>
                    <div class="stats-label">Products</div>
                  </div>
                </div>
              </div>
              <div class="col-md-2">
                <div class="card dashboard-card">
                  <div class="card-body stats-card">
                    <div class="stats-number"><%= posts.length %></div>
                    <div class="stats-label">News</div>
                  </div>
                </div>
              </div>
              <div class="col-md-2">
                <div class="card dashboard-card">
                  <div class="card-body stats-card">
                    <div class="stats-number"><%= files.length %></div>
                    <div class="stats-label">Files</div>
                  </div>
                </div>
              </div>
              <div class="col-md-2">
                <div class="card dashboard-card">
                  <div class="card-body stats-card">
                    <div class="stats-number"><%= logs.length %></div>
                    <div class="stats-label">Log Entries</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Analytics Dashboard -->
            <div class="row mt-4">
              <div class="col-md-8">
                <div class="card dashboard-card">
                  <div class="card-header">Website Analytics</div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="analytics-metric">
                          <div class="metric-icon">
                            <i class="bi bi-envelope-fill text-primary"></i>
                          </div>
                          <div class="metric-content">
                            <h4 class="metric-value" id="contactSubmissions">0</h4>
                            <p class="metric-label">Contact Form Submissions</p>
                            <small class="text-muted">Last 30 days</small>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="analytics-metric">
                          <div class="metric-icon">
                            <i class="bi bi-eye-fill text-success"></i>
                          </div>
                          <div class="metric-content">
                            <h4 class="metric-value" id="productViews">0</h4>
                            <p class="metric-label">Product Views</p>
                            <small class="text-muted">Last 30 days</small>
                          </div>
                        </div>
                      </div>
                    </div>
                    <hr>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="analytics-metric">
                          <div class="metric-icon">
                            <i class="bi bi-mouse text-info"></i>
                          </div>
                          <div class="metric-content">
                            <h4 class="metric-value" id="pageViews">--</h4>
                            <p class="metric-label">Page Views</p>
                            <small class="text-muted">Google Analytics</small>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="analytics-metric">
                          <div class="metric-icon">
                            <i class="bi bi-clock text-warning"></i>
                          </div>
                          <div class="metric-content">
                            <h4 class="metric-value" id="avgSession">--</h4>
                            <p class="metric-label">Avg. Session Duration</p>
                            <small class="text-muted">Google Analytics</small>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="mt-3">
                      <small class="text-muted">
                        <i class="bi bi-info-circle"></i>
                        Analytics data is tracked via Google Analytics. Configure your GA property to view real-time data.
                      </small>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card dashboard-card">
                  <div class="card-header">Recent Activity</div>
                  <div class="card-body">
                    <% if (logs.length > 0) { %>
                      <div class="list-group list-group-flush">
                        <% logs.forEach(log => { %>
                          <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                              <small class="text-muted"><%= new Date(log.createdAt).toLocaleString() %></small>
                              <p class="mb-1"><%= log.message %></p>
                            </div>
                            <span class="badge bg-<%= log.level === 'error' ? 'danger' : log.level === 'warn' ? 'warning' : 'info' %>">
                              <%= log.level %>
                            </span>
                          </div>
                        <% }) %>
                      </div>
                    <% } else { %>
                      <div class="empty-state">
                        <i class="bi bi-activity"></i>
                        <p>No recent activity</p>
                      </div>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Database Tab -->
          <div class="tab-pane fade" id="database">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">Database Management</h1>
            </div>

            <ul class="nav nav-tabs mb-4">
              <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#db-products">Products</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#db-posts">News</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#db-categories">Categories</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#db-users">Users</a>
              </li>
            </ul>

            <div class="tab-content">
              <!-- Products Sub-tab -->
              <div class="tab-pane fade show active" id="db-products">
                <h3>Products (<%= products.length %>)</h3>
                <% if (products.length > 0) { %>
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th>Name</th>
                          <th>Price</th>
                          <th>Category</th>
                          <th>Created</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% products.forEach(product => { %>
                          <tr>
                            <td><%= product.name %></td>
                            <td>$<%= product.price %></td>
                            <td>
                              <% const cat = product.category ? categories.find(c => c._id.toString() === product.category.toString()) : null %>
                              <%= cat ? cat.name : 'Uncategorized' %>
                            </td>
                            <td><%= new Date(product.createdAt).toLocaleDateString() %></td>
                          </tr>
                        <% }) %>
                      </tbody>
                    </table>
                  </div>
                <% } else { %>
                  <div class="empty-state">
                    <i class="bi bi-box"></i>
                    <p>No products in database</p>
                  </div>
                <% } %>
              </div>

              <!-- News Sub-tab -->
              <div class="tab-pane fade" id="db-posts">
                <h3>News (<%= posts.length %>)</h3>
                <% if (posts.length > 0) { %>
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th>Title</th>
                          <th>Category</th>
                          <th>Created</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% posts.forEach(post => { %>
                          <tr>
                            <td><%= post.title %></td>
                            <td>
                              <% const cat = post.category ? categories.find(c => c._id.toString() === post.category.toString()) : null %>
                              <%= cat ? cat.name : 'Uncategorized' %>
                            </td>
                            <td><%= new Date(post.createdAt).toLocaleDateString() %></td>
                          </tr>
                        <% }) %>
                      </tbody>
                    </table>
                  </div>
                <% } else { %>
                  <div class="empty-state">
                    <i class="bi bi-file-text"></i>
                    <p>No posts in database</p>
                  </div>
                <% } %>
              </div>

              <!-- Categories Sub-tab -->
              <div class="tab-pane fade" id="db-categories">
                <h3>Categories (<%= categories.length %>)</h3>
                <% if (categories.length > 0) { %>
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th>Name</th>
                          <th>Type</th>
                          <th>Description</th>
                          <th>Created</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% categories.forEach(cat => { %>
                          <tr>
                            <td><%= cat.name %></td>
                            <td>
                              <span class="badge bg-<%= cat.type === 'product' ? 'primary' : 'info' %>">
                                <%= cat.type %>
                              </span>
                            </td>
                            <td><%= cat.description %></td>
                            <td><%= new Date(cat.createdAt).toLocaleDateString() %></td>
                          </tr>
                        <% }) %>
                      </tbody>
                    </table>
                  </div>
                <% } else { %>
                  <div class="empty-state">
                    <i class="bi bi-tags"></i>
                    <p>No categories in database</p>
                  </div>
                <% } %>
              </div>

              <!-- Users Sub-tab -->
              <div class="tab-pane fade" id="db-users">
                <h3>Users (<%= users.length %>)</h3>
                <% if (users.length > 0) { %>
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th>Username</th>
                          <th>Email</th>
                          <th>Role</th>
                          <th>Status</th>
                          <th>Created</th>
                          <th>Last Login</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% users.forEach(user => { %>
                          <tr>
                            <td><%= user.username %></td>
                            <td><%= user.email %></td>
                            <td>
                              <span class="badge bg-<%= user.role === 'admin' ? 'danger' : 'secondary' %>">
                                <%= user.role %>
                              </span>
                            </td>
                            <td>
                              <span class="badge bg-<%= user.isActive ? 'success' : 'danger' %>">
                                <%= user.isActive ? 'Active' : 'Inactive' %>
                              </span>
                            </td>
                            <td><%= new Date(user.createdAt).toLocaleDateString() %></td>
                            <td><%= user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never' %></td>
                          </tr>
                        <% }) %>
                      </tbody>
                    </table>
                  </div>
                <% } else { %>
                  <div class="empty-state">
                    <i class="bi bi-people"></i>
                    <p>No users in database</p>
                  </div>
                <% } %>
              </div>
            </div>
          </div>

          <!-- Users Tab -->
          <div class="tab-pane fade" id="users">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">User Management</h1>
            </div>

            <ul class="nav nav-tabs mb-4">
              <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#manage-users">Manage Users</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#add-user">Add User</a>
              </li>
            </ul>

            <div class="tab-content">
              <div class="tab-pane fade show active" id="manage-users">
                <div class="d-flex justify-content-between mb-3">
                  <div>
                    <input type="text" id="userSearch" class="form-control d-inline-block w-25" placeholder="Search users...">
                  </div>
                </div>
                <div class="table-responsive">
                  <table class="table table-hover" id="usersTable">
                    <thead>
                      <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="usersTableBody">
                      <% users.slice(0, 10).forEach(user => { %>
                        <tr>
                          <td><%= user.username %></td>
                          <td><%= user.email %></td>
                          <td>
                            <span class="badge bg-<%= user.role === 'admin' ? 'danger' : 'secondary' %>">
                              <%= user.role %>
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-<%= user.isActive ? 'success' : 'danger' %>">
                              <%= user.isActive ? 'Active' : 'Inactive' %>
                            </span>
                          </td>
                          <td><%= new Date(user.createdAt).toLocaleDateString() %></td>
                          <td>
                            <button class="btn btn-sm btn-outline-primary action-btn" data-bs-toggle="modal" data-bs-target="#editUserModal<%= user._id %>">
                              <i class="bi bi-pencil"></i> Edit
                            </button>
                            <form method="POST" action="/admin/super/users/<%= user._id %>/toggle" class="d-inline">
                              <%- include('./components/csrf_input') %>
                              <button type="submit" class="btn btn-sm btn-outline-<%= user.isActive ? 'warning' : 'success' %> action-btn">
                                <i class="bi bi-<%= user.isActive ? 'pause' : 'play' %>"></i> <%= user.isActive ? 'Deactivate' : 'Activate' %>
                              </button>
                            </form>
                            <form method="POST" action="/admin/super/users/<%= user._id %>/delete" class="d-inline">
                              <%- include('./components/csrf_input') %>
                              <button type="submit" class="btn btn-sm btn-outline-danger action-btn"
                                      onclick="return confirm('Are you sure you want to delete this user?')">
                                <i class="bi bi-trash"></i> Delete
                              </button>
                            </form>
                          </td>
                        </tr>
                        <!-- Edit User Modal -->
                        <div class="modal fade" id="editUserModal<%= user._id %>" tabindex="-1">
                          <div class="modal-dialog">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title">Edit User</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                              </div>
                              <form method="POST" action="/admin/super/users/<%= user._id %>/edit">
                                <%- include('./components/csrf_input') %>
                                <div class="modal-body">
                                  <div class="row">
                                    <div class="col-md-6">
                                      <div class="mb-3">
                                        <label class="form-label">First Name</label>
                                        <input type="text" class="form-control" name="firstName" value="<%= user.firstName %>" required>
                                      </div>
                                    </div>
                                    <div class="col-md-6">
                                      <div class="mb-3">
                                        <label class="form-label">Last Name</label>
                                        <input type="text" class="form-control" name="lastName" value="<%= user.lastName %>" required>
                                      </div>
                                    </div>
                                  </div>
                                  <div class="mb-3">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-control" name="username" value="<%= user.username %>" required>
                                  </div>
                                  <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" name="email" value="<%= user.email %>" required>
                                  </div>
                                  <div class="mb-3">
                                    <label class="form-label">Role</label>
                                    <select class="form-control" name="role">
                                      <option value="user" <%= user.role === 'user' ? 'selected' : '' %>>User</option>
                                      <option value="admin" <%= user.role === 'admin' ? 'selected' : '' %>>Admin</option>
                                      <option value="superadmin" <%= user.role === 'superadmin' ? 'selected' : '' %>>Super Admin</option>
                                    </select>
                                  </div>
                                  <div class="mb-3">
                                    <label class="form-label">New Password (leave blank to keep current)</label>
                                    <input type="password" class="form-control" name="password">
                                  </div>
                                </div>
                                <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                  <button type="submit" class="btn btn-primary">Update User</button>
                                </div>
                              </form>
                            </div>
                          </div>
                        </div>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
                <nav id="usersPagination" class="mt-3">
                  <ul class="pagination justify-content-center">
                    <!-- Pagination will be populated by JavaScript -->
                  </ul>
                </nav>
              </div>

              <div class="tab-pane fade" id="add-user">
                <div class="form-section">
                  <h3>Add New User</h3>
                  <form method="POST" action="/admin/super/users">
                    <%- include('./components/csrf_input') %>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="userFirstName" class="form-label">First Name</label>
                          <input type="text" class="form-control" id="userFirstName" name="firstName">
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="userLastName" class="form-label">Last Name</label>
                          <input type="text" class="form-control" id="userLastName" name="lastName">
                        </div>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="userUsername" class="form-label">Username</label>
                          <input type="text" class="form-control" id="userUsername" name="username" required>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="userEmail" class="form-label">Email</label>
                          <input type="email" class="form-control" id="userEmail" name="email" required>
                        </div>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="userPassword" class="form-label">Password</label>
                          <input type="password" class="form-control" id="userPassword" name="password" required>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="userRole" class="form-label">Role</label>
                          <select class="form-control" id="userRole" name="role">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                            <option value="superadmin">Super Admin</option>
                          </select>
                        </div>
                      </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-plus-circle"></i> Add User
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Storage Tab -->
          <div class="tab-pane fade" id="storage">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">Storage Management</h1>
            </div>

            <h3>Uploaded Files (<%= files.length %>)</h3>
            <% if (files.length > 0) { %>
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Filename</th>
                      <th>Size</th>
                      <th>Modified</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% files.forEach(file => { %>
                      <tr>
                        <td><%= file.name %></td>
                        <td><%= (file.size / 1024).toFixed(2) %> KB</td>
                        <td><%= new Date(file.modified).toLocaleString() %></td>
                        <td>
                          <a href="/uploads/<%= file.name %>" target="_blank" class="btn btn-sm btn-outline-info action-btn">
                            <i class="bi bi-eye"></i> View
                          </a>
                          <form method="POST" action="/admin/super/storage/<%= file.name %>/delete" class="d-inline">
                            <%- include('./components/csrf_input') %>
                            <button type="submit" class="btn btn-sm btn-outline-danger action-btn"
                                    onclick="return confirm('Are you sure you want to delete this file?')">
                              <i class="bi bi-trash"></i> Delete
                            </button>
                          </form>
                        </td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            <% } else { %>
              <div class="empty-state">
                <i class="bi bi-folder"></i>
                <p>No files uploaded yet</p>
              </div>
            <% } %>
          </div>

          <!-- Logs Tab -->
          <div class="tab-pane fade" id="logs">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">Activity Logs</h1>
            </div>

            <div class="d-flex justify-content-between mb-3">
              <div>
                <select id="logLevelFilter" class="form-select d-inline-block w-auto me-2">
                  <option value="all">All Levels</option>
                  <option value="info">Info</option>
                  <option value="warn">Warning</option>
                  <option value="error">Error</option>
                </select>
                <input type="text" id="logSearch" class="form-control d-inline-block w-25" placeholder="Search logs...">
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover" id="logsTable">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Level</th>
                    <th>User</th>
                    <th>Message</th>
                    <th>IP</th>
                  </tr>
                </thead>
                <tbody id="logsTableBody">
                  <% if (logs.length > 0) { %>
                    <% logs.forEach(log => { %>
                      <tr>
                        <td><%= new Date(log.createdAt).toLocaleString() %></td>
                        <td><span class="badge bg-<%= log.level === 'error' ? 'danger' : log.level === 'warn' ? 'warning' : 'info' %>"><%= log.level %></span></td>
                        <td><%= log.user ? log.user.username : 'System' %></td>
                        <td><%= log.message %></td>
                        <td><%= log.ip || 'N/A' %></td>
                      </tr>
                    <% }) %>
                  <% } else { %>
                    <tr>
                      <td colspan="5" class="text-center">No logs available</td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
            <nav id="logsPagination" class="mt-3">
              <ul class="pagination justify-content-center">
                <!-- Pagination will be populated by JavaScript -->
              </ul>
            </nav>
          </div>

          <!-- User Paths Tab -->
          <div class="tab-pane fade" id="user-paths">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">User Paths & Analytics</h1>
            </div>

            <div class="row">
              <div class="col-md-8">
                <div class="card dashboard-card">
                  <div class="card-header">User Flow Visualization</div>
                  <div class="card-body">
                    <canvas id="userFlowChart" width="400" height="200"></canvas>
                    <div class="mt-3">
                      <small class="text-muted">
                        <i class="bi bi-info-circle"></i>
                        This chart shows the most common user navigation paths over the last 7 days.
                      </small>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card dashboard-card">
                  <div class="card-header">Popular Content</div>
                  <div class="card-body">
                    <div id="popularContent">
                      <div class="empty-state">
                        <i class="bi bi-bar-chart"></i>
                        <p>Loading popular content...</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row mt-4">
              <div class="col-md-6">
                <div class="card dashboard-card">
                  <div class="card-header">Conversion Funnel</div>
                  <div class="card-body">
                    <div id="conversionFunnel">
                      <div class="funnel-step">
                        <div class="funnel-label">Page Views</div>
                        <div class="funnel-value" id="funnel-page-views">--</div>
                        <div class="funnel-bar">
                          <div class="funnel-fill" style="width: 100%"></div>
                        </div>
                      </div>
                      <div class="funnel-step">
                        <div class="funnel-label">Product Views</div>
                        <div class="funnel-value" id="funnel-product-views">--</div>
                        <div class="funnel-bar">
                          <div class="funnel-fill" style="width: 0%"></div>
                        </div>
                      </div>
                      <div class="funnel-step">
                        <div class="funnel-label">Contact Submissions</div>
                        <div class="funnel-value" id="funnel-contact-submissions">--</div>
                        <div class="funnel-bar">
                          <div class="funnel-fill" style="width: 0%"></div>
                        </div>
                      </div>
                    </div>
                    <div class="mt-3">
                      <small class="text-muted">
                        <i class="bi bi-info-circle"></i>
                        Conversion rates based on last 30 days of data.
                      </small>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card dashboard-card">
                  <div class="card-header">User Engagement Metrics</div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="analytics-metric">
                          <div class="metric-icon">
                            <i class="bi bi-clock-history text-primary"></i>
                          </div>
                          <div class="metric-content">
                            <h4 class="metric-value" id="avgSessionDuration">--</h4>
                            <p class="metric-label">Avg. Session Duration</p>
                            <small class="text-muted">Last 30 days</small>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="analytics-metric">
                          <div class="metric-icon">
                            <i class="bi bi-mouse text-success"></i>
                          </div>
                          <div class="metric-content">
                            <h4 class="metric-value" id="pagesPerSession">--</h4>
                            <p class="metric-label">Pages per Session</p>
                            <small class="text-muted">Last 30 days</small>
                          </div>
                        </div>
                      </div>
                    </div>
                    <hr>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="analytics-metric">
                          <div class="metric-icon">
                            <i class="bi bi-arrow-repeat text-info"></i>
                          </div>
                          <div class="metric-content">
                            <h4 class="metric-value" id="bounceRate">--</h4>
                            <p class="metric-label">Bounce Rate</p>
                            <small class="text-muted">Single page sessions</small>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="analytics-metric">
                          <div class="metric-icon">
                            <i class="bi bi-graph-up text-warning"></i>
                          </div>
                          <div class="metric-content">
                            <h4 class="metric-value" id="returnVisitors">--</h4>
                            <p class="metric-label">Return Visitors</p>
                            <small class="text-muted">Last 30 days</small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row mt-4">
              <div class="col-md-12">
                <div class="card dashboard-card">
                  <div class="card-header">Recent User Sessions</div>
                  <div class="card-body">
                    <div id="recentSessions">
                      <div class="empty-state">
                        <i class="bi bi-diagram-3"></i>
                        <p>Loading recent sessions...</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Logout Confirmation Modal -->
  <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="logoutModalLabel">Confirm Logout</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to logout?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <form method="POST" action="/admin/logout" class="d-inline">
            <%- include('./components/csrf_input') %>
            <button type="submit" class="btn btn-danger">Logout</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Dark Mode Toggle - Moved to bottom -->
  <div class="dark-mode-toggle fixed-bottom-end" id="darkModeToggle" title="Toggle Dark Mode" style="margin: 20px; z-index: 1050;">
    <i class="bi bi-moon-fill" id="darkModeIcon"></i>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- CSRF token holder for client scripts -->
  <div id="csrf-holder" data-csrf="<%= csrfToken %>" style="display:none"></div>
  <script>
    // Global fetch wrapper: if a fetch call returns 401/403, redirect to login
    (function() {
      window.__isLoggingOut = false;
      try {
        document.querySelectorAll('form[action="/admin/logout"]').forEach(form => {
          form.addEventListener('submit', function() {
            window.__isLoggingOut = true;
          });
        });
      } catch (e) {}

      const _fetch = window.fetch;
      window.fetch = function(resource, init) {
        init = init || {};
        if (!init.credentials) init.credentials = 'same-origin';
        return _fetch(resource, init).then(res => {
          if ((res.status === 401 || res.status === 403) && !window.__isLoggingOut) {
            window.location.href = '/admin/login';
            return Promise.reject(new Error('Unauthorized'));
          }
          return res;
        }).catch(err => {
          if (window.__isLoggingOut) return new Promise(() => {});
          throw err;
        });
      };
    })();
  </script>
  <script>
    // Dashboard initialization
    document.addEventListener('DOMContentLoaded', function() {
      // Load logs on logs tab activation
      document.querySelector('a[href="#logs"]').addEventListener('shown.bs.tab', function() {
        loadLogs();
      });

      // User search
      document.getElementById('userSearch').addEventListener('input', function() {
        loadUsers(1, this.value);
      });

      // Log filters
      document.getElementById('logLevelFilter').addEventListener('change', loadLogs);
      document.getElementById('logSearch').addEventListener('input', loadLogs);

    // Load analytics data
    loadAnalyticsData();
    loadUserPathsData();
    });

    // Load analytics data from server
    function loadAnalyticsData() {
      fetch('/admin/super/analytics', { credentials: 'same-origin' })
        .then(function(response) {
          if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
              window.location.href = '/admin/login';
            }
            throw new Error('Failed to load analytics');
          }
          return response.json();
        })
        .then(function(data) {
          document.getElementById('contactSubmissions').textContent = data.contactSubmissions || 0;
          document.getElementById('productViews').textContent = data.productViews || 0;
          document.getElementById('pageViews').textContent = data.pageViews || '--';
          document.getElementById('avgSession').textContent = data.avgSession || '--';
        })
        .catch(function(err) {
          console.error('Error loading analytics', err);
        });
    }

    // Load user paths data
    function loadUserPathsData() {
      fetch('/admin/super/analytics', { credentials: 'same-origin' })
        .then(function(response) {
          if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
              window.location.href = '/admin/login';
            }
            throw new Error('Failed to load user paths data');
          }
          return response.json();
        })
        .then(function(data) {
          if (!data) {
            console.error('No data received from analytics endpoint');
            return;
          }

          // Update popular content
          updatePopularContent(data.topPages);

          // Update conversion funnel
          updateConversionFunnel(data.pageViews, data.productViews, data.contactSubmissions);

          // Update user engagement metrics
          updateUserEngagementMetrics(data.avgSession, data.userPaths);

          // Update recent sessions
          updateRecentSessions(data.userPaths);

          // Create user flow chart
          createUserFlowChart(data.userPaths);
        })
        .catch(function(err) {
          console.error('Error loading user paths data', err);
        });
    }

    function updatePopularContent(topPages) {
      const container = document.getElementById('popularContent');
      if (!topPages || topPages.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-bar-chart"></i><p>No popular content data available</p></div>';
        return;
      }

      let html = '<div class="list-group list-group-flush">';
      topPages.slice(0, 5).forEach(page => {
        html += `<div class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>${page._id}</strong>
            <small class="text-muted d-block">${page.count} views</small>
          </div>
          <span class="badge bg-primary">${page.count}</span>
        </div>`;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    function updateConversionFunnel(pageViews, productViews, contactSubmissions) {
      const totalPageViews = pageViews || 0;
      const totalProductViews = productViews || 0;
      const totalContactSubmissions = contactSubmissions || 0;

      document.getElementById('funnel-page-views').textContent = totalPageViews;
      document.getElementById('funnel-product-views').textContent = totalProductViews;
      document.getElementById('funnel-contact-submissions').textContent = totalContactSubmissions;

      // Calculate percentages
      const productPercentage = totalPageViews > 0 ? (totalProductViews / totalPageViews * 100).toFixed(1) : 0;
      const contactPercentage = totalPageViews > 0 ? (totalContactSubmissions / totalPageViews * 100).toFixed(1) : 0;

      document.querySelector('#funnel-product-views').nextElementSibling.style.width = productPercentage + '%';
      document.querySelector('#funnel-contact-submissions').nextElementSibling.style.width = contactPercentage + '%';
    }

    function updateUserEngagementMetrics(avgSession, userPaths) {
      document.getElementById('avgSessionDuration').textContent = avgSession ? avgSession + 's' : '--';

      // Calculate pages per session
      if (userPaths && userPaths.length > 0) {
        const totalPages = userPaths.reduce((sum, path) => sum + path.count, 0);
        const avgPagesPerSession = (totalPages / userPaths.length).toFixed(1);
        document.getElementById('pagesPerSession').textContent = avgPagesPerSession;
      } else {
        document.getElementById('pagesPerSession').textContent = '--';
      }

      // Calculate bounce rate (sessions with only 1 page)
      if (userPaths && userPaths.length > 0) {
        const bouncedSessions = userPaths.filter(path => path.count === 1).length;
        const bounceRate = ((bouncedSessions / userPaths.length) * 100).toFixed(1) + '%';
        document.getElementById('bounceRate').textContent = bounceRate;
      } else {
        document.getElementById('bounceRate').textContent = '--';
      }

      // Return visitors (placeholder - would need more complex logic)
      document.getElementById('returnVisitors').textContent = '--';
    }

    function updateRecentSessions(userPaths) {
      const container = document.getElementById('recentSessions');
      if (!userPaths || userPaths.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-diagram-3"></i><p>No recent session data available</p></div>';
        return;
      }

      let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Session ID</th><th>Pages Visited</th><th>Duration</th></tr></thead><tbody>';
      userPaths.slice(0, 10).forEach(session => {
        const pages = session.pages.join('  ');
        const duration = session.timestamps.length > 1 ?
          Math.round((new Date(session.timestamps[session.timestamps.length - 1]) - new Date(session.timestamps[0])) / 1000) + 's' :
          'N/A';
        html += `<tr><td><small>${session._id.substring(0, 8)}...</small></td><td><small>${pages}</small></td><td>${duration}</td></tr>`;
      });
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function createUserFlowChart(userPaths) {
      const ctx = document.getElementById('userFlowChart').getContext('2d');

      if (!userPaths || userPaths.length === 0) {
        // Create empty chart
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['No Data'],
            datasets: [{
              label: 'User Paths',
              data: [0],
              backgroundColor: 'rgba(220, 53, 69, 0.5)',
              borderColor: 'rgba(220, 53, 69, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
        return;
      }

      // Create a simple flow chart showing page transitions
      const pageTransitions = {};
      userPaths.forEach(session => {
        for (let i = 0; i < session.pages.length - 1; i++) {
          const from = session.pages[i];
          const to = session.pages[i + 1];
          const key = `${from}  ${to}`;
          pageTransitions[key] = (pageTransitions[key] || 0) + 1;
        }
      });

      const labels = Object.keys(pageTransitions).slice(0, 10);
      const data = labels.map(label => pageTransitions[label]);

      new Chart(ctx, {
        type: 'horizontalBar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Transition Count',
            data: data,
            backgroundColor: 'rgba(220, 53, 69, 0.5)',
            borderColor: 'rgba(220, 53, 69, 1)',
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          scales: {
            x: {
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    function loadUsers(page = 1, search = '') {
  fetch(`/admin/super/users?page=${page}&search=${encodeURIComponent(search)}`, { credentials: 'same-origin' })
        .then(function(response) {
          if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
              window.location.href = '/admin/login';
            }
            throw new Error('Failed to load users');
          }
          return response.json();
        })
        .then(function(data) {
          const tbody = document.getElementById('usersTableBody');
          const csrfToken = document.getElementById('csrf-holder')?.getAttribute('data-csrf') || '';
          tbody.innerHTML = data.users.map(function(user) {
            const toggleForm = '<form method="POST" action="/admin/super/users/' + user._id + '/toggle" class="d-inline">' + (csrfToken ? '<input type="hidden" name="_csrf" value="' + csrfToken + '">' : '') + '<button type="submit" class="btn btn-sm btn-outline-' + (user.isActive ? 'warning' : 'success') + ' action-btn"><i class="bi bi-' + (user.isActive ? 'pause' : 'play') + '"></i> ' + (user.isActive ? 'Deactivate' : 'Activate') + '</button></form>';
            const deleteForm = '<form method="POST" action="/admin/super/users/' + user._id + '/delete" class="d-inline">' + (csrfToken ? '<input type="hidden" name="_csrf" value="' + csrfToken + '">' : '') + '<button type="submit" class="btn btn-sm btn-outline-danger action-btn" onclick="return confirm(\'Are you sure you want to delete this user?\')"><i class="bi bi-trash"></i> Delete</button></form>';
            return '<tr><td>' + user.username + '</td><td>' + user.email + '</td><td><span class="badge bg-' + (user.role === 'admin' ? 'danger' : 'secondary') + '">' + user.role + '</span></td><td><span class="badge bg-' + (user.isActive ? 'success' : 'danger') + '">' + (user.isActive ? 'Active' : 'Inactive') + '</span></td><td>' + new Date(user.createdAt).toLocaleDateString() + '</td><td><button class="btn btn-sm btn-outline-primary action-btn" onclick="editUser(\'' + user._id + '\')"><i class="bi bi-pencil"></i> Edit</button>' + toggleForm + deleteForm + '</td></tr>';
          }).join('');

          updatePagination('usersPagination', data.page, data.pages, function(p) { loadUsers(p, search); });
        }).catch(function(err) {
          console.error('Error loading users', err);
        });
    }

    function loadLogs(page = 1) {
      const level = document.getElementById('logLevelFilter').value;
      const search = document.getElementById('logSearch').value;
  fetch('/admin/super/logs?page=' + page + '&level=' + level + '&search=' + encodeURIComponent(search), { credentials: 'same-origin' })
        .then(function(response) {
          if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
              window.location.href = '/admin/login';
            }
            throw new Error('Failed to load logs');
          }
          return response.json();
        })
        .then(function(data) {
          const tbody = document.getElementById('logsTableBody');
          tbody.innerHTML = data.logs.map(function(log) {
            return '<tr><td>' + new Date(log.createdAt).toLocaleString() + '</td><td><span class="badge bg-' + (log.level === 'error' ? 'danger' : log.level === 'warn' ? 'warning' : 'info') + '">' + log.level + '</span></td><td>' + (log.user ? log.user.username : 'System') + '</td><td>' + log.message + '</td><td>' + (log.ip || 'N/A') + '</td></tr>';
          }).join('');

          updatePagination('logsPagination', data.page, data.pages, loadLogs);
        }).catch(function(err) {
          console.error('Error loading logs', err);
        });
    }

    function updatePagination(paginationId, currentPage, totalPages, callback) {
      const pagination = document.getElementById(paginationId);
      pagination.innerHTML = '';
      if (currentPage > 1) {
        const li = document.createElement('li');
        li.className = 'page-item';
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.textContent = 'Previous';
        a.addEventListener('click', (e) => { e.preventDefault(); callback(currentPage - 1); });
        li.appendChild(a);
        pagination.appendChild(li);
      }
      for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        const li = document.createElement('li');
        li.className = 'page-item' + (i === currentPage ? ' active' : '');
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.textContent = i;
        a.addEventListener('click', (e) => { e.preventDefault(); callback(i); });
        li.appendChild(a);
        pagination.appendChild(li);
      }
      if (currentPage < totalPages) {
        const li = document.createElement('li');
        li.className = 'page-item';
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.textContent = 'Next';
        a.addEventListener('click', (e) => { e.preventDefault(); callback(currentPage + 1); });
        li.appendChild(a);
        pagination.appendChild(li);
      }
    }

    // Dark Mode Toggle Functionality
    document.addEventListener('DOMContentLoaded', function() {
      const toggle = document.getElementById('darkModeToggle');
      const icon = document.getElementById('darkModeIcon');
      const body = document.body;

      // Load saved state from localStorage
      const isDark = localStorage.getItem('darkMode') === 'true';
      if (isDark) {
        body.classList.add('dark-mode');
        toggle.classList.add('dark-mode-active');
        icon.className = 'bi bi-sun-fill';
      }

      // Toggle dark mode on click
      toggle.addEventListener('click', function() {
        body.classList.toggle('dark-mode');
        toggle.classList.toggle('dark-mode-active');
        const isNowDark = body.classList.contains('dark-mode');
        localStorage.setItem('darkMode', isNowDark);
        icon.className = isNowDark ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
      });
    });
