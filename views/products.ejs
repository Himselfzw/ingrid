<!DOCTYPE html>
<html lang="en">
<%- include('./components/head', { title: 'Products - Ingrid Chemicals' }) %>
<body>
  <%- include('./components/header', { currentPage: 'products' }) %>

  <%- include('./components/hero', { heroTitle: 'Our Mining Solutions', heroSubtitle: 'Discover our comprehensive range of high-performance mining chemicals and industrial equipment designed to optimize your operations and ensure safety.' }) %>

  <!-- Breadcrumb Navigation -->
  <nav aria-label="breadcrumb" class="bg-light py-2">
    <div class="container">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">Products</li>
      </ol>
    </div>
  </nav>

  <!-- Products Section -->
  <section class="py-5">
    <div class="container">
      <!-- Filters and Search -->
      <div class="row mb-4">
        <div class="col-lg-8">
          <div class="input-group">
            <input type="text" id="searchInput" class="form-control" placeholder="Search products..." aria-label="Search products">
            <button class="btn btn-outline-secondary" type="button" id="searchBtn">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>
        <div class="col-lg-4">
          <select class="form-select" id="categoryFilter" aria-label="Filter by category">
            <option value="">All Categories</option>
            <% if (categories && categories.length > 0) { %>
              <% categories.forEach(category => { %>
                <option value="<%= category._id %>"><%= category.name %></option>
              <% }) %>
            <% } %>
          </select>
        </div>
      </div>

      <!-- Products Grid -->
      <div class="row" id="productsContainer">
        <% if (products && products.length > 0) { %>
          <% products.forEach(product => { %>
            <div class="col-lg-4 col-md-6 mb-4 product-item" data-category="<%= product.category ? product.category._id : '' %>">
              <div class="card card-product">
                <% if (product.image) { %>
                  <img src="/uploads/<%= product.image %>" class="card-img-top" alt="<%= product.name %>" loading="lazy">
                <% } else { %>
                  <img src="https://images.unsplash.com/photo-1581094794329-c8112a89af12?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" class="card-img-top" alt="<%= product.name %>" loading="lazy">
                <% } %>
                <div class="card-body">
                  <h5 class="card-title"><%= product.name %></h5>
                  <p class="card-text"><%= product.description.substring(0, 120) %>...</p>
                  <div class="d-flex justify-content-between align-items-center">
                    <% if (product.price) { %>
                      <span class="text-primary fw-bold">$<%= product.price %></span>
                    <% } %>
                    <a href="/products/<%= product._id %>" class="btn btn-primary" onclick="trackProductView('<%= product._id %>', '<%= product.name %>')">View Details</a>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="col-12 text-center py-5">
            <div class="empty-state">
              <i class="bi bi-box-seam display-1 text-muted mb-3"></i>
              <h3>No Products Found</h3>
              <p class="text-muted">We're currently updating our product catalog. Please check back soon.</p>
            </div>
          </div>
        <% } %>
      </div>

      <!-- Pagination -->
      <nav aria-label="Products pagination" class="mt-4">
        <ul class="pagination justify-content-center" id="pagination">
          <!-- Pagination will be generated by JavaScript -->
        </ul>
      </nav>
    </div>
  </section>

  <%- include('./components/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Products data for client-side filtering and pagination
    const products = <%- JSON.stringify(products || []) %>;
    const categories = <%- JSON.stringify(categories || []) %>;
    let currentPage = 1;
    const itemsPerPage = 9;
    let filteredProducts = [...products];

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', filterProducts);
    document.getElementById('searchBtn').addEventListener('click', filterProducts);
    document.getElementById('categoryFilter').addEventListener('change', filterProducts);

    function filterProducts() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const categoryId = document.getElementById('categoryFilter').value;

      filteredProducts = products.filter(product => {
        const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                             product.description.toLowerCase().includes(searchTerm);
        const matchesCategory = !categoryId || (product.category && product.category._id === categoryId);
        return matchesSearch && matchesCategory;
      });

      currentPage = 1;
      renderProducts();
      renderPagination();
    }

    function renderProducts() {
      const container = document.getElementById('productsContainer');
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const productsToShow = filteredProducts.slice(startIndex, endIndex);

      if (productsToShow.length === 0) {
        container.innerHTML = `
          <div class="col-12 text-center py-5">
            <div class="empty-state">
              <i class="bi bi-search display-1 text-muted mb-3"></i>
              <h3>No Products Found</h3>
              <p class="text-muted">Try adjusting your search or filter criteria.</p>
            </div>
          </div>
        `;
        return;
      }

      var html = '';
      for (var i = 0; i < productsToShow.length; i++) {
        var product = productsToShow[i];
        var imageSrc = product.image ? '/uploads/' + product.image : 'https://images.unsplash.com/photo-1581094794329-c8112a89af12?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80';
        var priceHtml = product.price ? '<span class="text-primary fw-bold">$' + product.price + '</span>' : '';
        var categoryId = product.category ? product.category._id : '';
        var name = product.name;
        var description = product.description.substring(0, 120) + '...';
        var productId = product._id;
        html += '<div class="col-lg-4 col-md-6 mb-4 product-item" data-category="' + categoryId + '">' +
          '<div class="card card-product">' +
            '<img src="' + imageSrc + '" class="card-img-top" alt="' + name + '" loading="lazy">' +
            '<div class="card-body">' +
              '<h5 class="card-title">' + name + '</h5>' +
              '<p class="card-text">' + description + '</p>' +
              '<div class="d-flex justify-content-between align-items-center">' +
                priceHtml +
                '<a href="/products/' + productId + '" class="btn btn-primary" onclick="trackProductView(\'' + productId + '\', \'' + name.replace(/'/g, '\\\'') + '\')">View Details</a>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';
      }
      container.innerHTML = html;
    }

    function renderPagination() {
      const pagination = document.getElementById('pagination');
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);

      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }

      let paginationHTML = '';

      // Previous button
      paginationHTML += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage - 1})" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
        </a>
      </li>`;

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        paginationHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
          <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
        </li>`;
      }

      // Next button
      paginationHTML += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage + 1})" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>`;

      pagination.innerHTML = paginationHTML;
    }

    function changePage(page) {
      if (page < 1 || page > Math.ceil(filteredProducts.length / itemsPerPage)) return;
      currentPage = page;
      renderProducts();
      renderPagination();
      window.scrollTo({ top: document.querySelector('.container').offsetTop - 100, behavior: 'smooth' });
    }

    // Analytics tracking function is defined globally in head.ejs

    // Initial render
    renderProducts();
    renderPagination();
  </script>
</body>
</html>
