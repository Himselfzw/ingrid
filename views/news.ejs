<!DOCTYPE html>
<html lang="en">
<%- include('./components/head', { title: 'News - Ingrid Chemicals' }) %>
<body>
  <%- include('./components/header', { currentPage: 'news' }) %>

  <%- include('./components/hero', { heroTitle: 'Latest Industry News', heroSubtitle: 'Stay informed with the latest developments, innovations, and insights from the mining chemicals and equipment industry.' }) %>

  <!-- Breadcrumb Navigation -->
  <nav aria-label="breadcrumb" class="bg-light py-2">
    <div class="container">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">News</li>
      </ol>
    </div>
  </nav>

  <!-- News Section -->
  <section class="py-5">
    <div class="container">
      <!-- Filters and Search -->
      <div class="row mb-4">
        <div class="col-lg-8">
          <div class="input-group">
            <input type="text" id="searchInput" class="form-control" placeholder="Search news..." aria-label="Search news">
            <button class="btn btn-outline-secondary" type="button" id="searchBtn">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>
        <div class="col-lg-4">
          <select class="form-select" id="categoryFilter" aria-label="Filter by category">
            <option value="">All Categories</option>
            <% if (categories && categories.length > 0) { %>
              <% categories.forEach(category => { %>
                <option value="<%= category._id %>"><%= category.name %></option>
              <% }) %>
            <% } %>
          </select>
        </div>
      </div>

      <!-- News Grid -->
      <div class="row" id="newsContainer">
        <% if (posts && posts.length > 0) { %>
          <% posts.forEach(post => { %>
            <div class="col-lg-6 col-md-6 mb-4 news-item" data-category="<%= post.category ? post.category._id : '' %>">
              <div class="card card-news h-100">
                <% if (post.image) { %>
                  <img src="/uploads/<%= post.image %>" class="card-img-top" alt="<%= post.title %>" loading="lazy" style="height: 200px; object-fit: cover;">
                <% } else { %>
                  <img src="https://images.unsplash.com/photo-1504711434969-e33886168f5c?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" class="card-img-top" alt="<%= post.title %>" loading="lazy" style="height: 200px; object-fit: cover;">
                <% } %>
                <div class="card-body d-flex flex-column">
                  <span class="news-date mb-2"><i class="bi bi-calendar-event me-1"></i><%= new Date(post.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %></span>
                  <h5 class="card-title"><%= post.title %></h5>
                  <p class="card-text flex-grow-1"><%= post.content.substring(0, 150) %>...</p>
                  <div class="mt-auto">
                    <% if (post.author) { %>
                      <small class="text-muted">By <%= post.author %></small>
                    <% } %>
                    <a href="/news/<%= post._id %>" class="btn btn-outline-primary btn-sm float-end">Read More</a>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="col-12 text-center py-5">
            <div class="empty-state">
              <i class="bi bi-newspaper display-1 text-muted mb-3"></i>
              <h3>No News Available</h3>
              <p class="text-muted">We're working on bringing you the latest updates. Check back soon!</p>
            </div>
          </div>
        <% } %>
      </div>

      <!-- Pagination -->
      <nav aria-label="News pagination" class="mt-4">
        <ul class="pagination justify-content-center" id="pagination">
          <!-- Pagination will be generated by JavaScript -->
        </ul>
      </nav>
    </div>
  </section>

  <%- include('./components/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // News data for client-side filtering and pagination
    const posts = <%- JSON.stringify(posts || []) %>;
    const categories = <%- JSON.stringify(categories || []) %>;
    let currentPage = 1;
    const itemsPerPage = 8;
    let filteredPosts = [...posts];

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', filterPosts);
    document.getElementById('searchBtn').addEventListener('click', filterPosts);
    document.getElementById('categoryFilter').addEventListener('change', filterPosts);

    function filterPosts() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const categoryId = document.getElementById('categoryFilter').value;

      filteredPosts = posts.filter(post => {
        const matchesSearch = post.title.toLowerCase().includes(searchTerm) ||
                             post.content.toLowerCase().includes(searchTerm) ||
                             (post.author && post.author.toLowerCase().includes(searchTerm));
        const matchesCategory = !categoryId || (post.category && post.category._id === categoryId);
        return matchesSearch && matchesCategory;
      });

      currentPage = 1;
      renderPosts();
      renderPagination();
    }

    function renderPosts() {
      const container = document.getElementById('newsContainer');
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const postsToShow = filteredPosts.slice(startIndex, endIndex);

      if (postsToShow.length === 0) {
        container.innerHTML = `
          <div class="col-12 text-center py-5">
            <div class="empty-state">
              <i class="bi bi-search display-1 text-muted mb-3"></i>
              <h3>No News Found</h3>
              <p class="text-muted">Try adjusting your search or filter criteria.</p>
            </div>
          </div>
        `;
        return;
      }

      var html = '';
      for (var i = 0; i < postsToShow.length; i++) {
        var post = postsToShow[i];
        var imageSrc = post.image ? '/uploads/' + post.image : 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80';
        var categoryId = post.category ? post.category._id : '';
        var title = post.title;
        var content = post.content.substring(0, 150) + '...';
        var author = post.author || '';
        var date = new Date(post.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        var postId = post._id;
        html += '<div class="col-lg-6 col-md-6 mb-4 news-item" data-category="' + categoryId + '">' +
          '<div class="card card-news h-100">' +
            '<img src="' + imageSrc + '" class="card-img-top" alt="' + title + '" loading="lazy" style="height: 200px; object-fit: cover;">' +
            '<div class="card-body d-flex flex-column">' +
              '<span class="news-date mb-2"><i class="bi bi-calendar-event me-1"></i>' + date + '</span>' +
              '<h5 class="card-title">' + title + '</h5>' +
              '<p class="card-text flex-grow-1">' + content + '</p>' +
              '<div class="mt-auto">' +
                (author ? '<small class="text-muted">By ' + author + '</small>' : '') +
                '<a href="/news/' + postId + '" class="btn btn-outline-primary btn-sm float-end">Read More</a>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';
      }
      container.innerHTML = html;
    }

    function renderPagination() {
      const pagination = document.getElementById('pagination');
      const totalPages = Math.ceil(filteredPosts.length / itemsPerPage);

      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }

      let paginationHTML = '';

      // Previous button
      paginationHTML += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage - 1})" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
        </a>
      </li>`;

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        paginationHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
          <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
        </li>`;
      }

      // Next button
      paginationHTML += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage + 1})" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>`;

      pagination.innerHTML = paginationHTML;
    }

    function changePage(page) {
      if (page < 1 || page > Math.ceil(filteredPosts.length / itemsPerPage)) return;
      currentPage = page;
      renderPosts();
      renderPagination();
      window.scrollTo({ top: document.querySelector('.container').offsetTop - 100, behavior: 'smooth' });
    }

    // Initial render
    renderPosts();
    renderPagination();
  </script>
</body>
</html>
